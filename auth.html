<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Auth</title>
<style>
body{margin:0;font-family:system-ui;background:#05070f;color:#fff;display:flex;justify-content:center;align-items:center}
.card{max-width:420px;width:100%;padding:20px;background:rgba(255,255,255,.12);border-radius:20px}
input,button{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:none}
button{background:#ffd36e;font-weight:800}
#msg{text-align:center;margin-top:10px}
</style>
</head>
<body>

<div class="card">
<h2>Login</h2>
<input id="loginEmail" type="email" placeholder="Email">
<input id="loginPassword" type="password" placeholder="Password">
<button id="loginBtn">Login</button>

<hr>

<h2>Register</h2>
<input id="regEmail" type="email" placeholder="Email">
<input id="regPassword" type="password" placeholder="Password">
<input id="regConfirm" type="password" placeholder="Confirm Password">
<button id="registerBtn">Register</button>
<div id="msg"></div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import {
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  doc,setDoc,getDoc,updateDoc,addDoc,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);
const refCode = params.get("ref");

loginBtn.onclick = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,loginEmail.value,loginPassword.value);
    location.href="index.html";
  }catch(e){ msg.innerText=e.message }
};

registerBtn.onclick = async ()=>{
  if(regPassword.value!==regConfirm.value){msg.innerText="Password mismatch";return;}

  const cred = await createUserWithEmailAndPassword(auth,regEmail.value,regPassword.value);
  const uid = cred.user.uid;
  const myCode = uid.slice(0,8).toUpperCase();

  await setDoc(doc(db,"users",uid),{
    email:regEmail.value,
    balance:0,
    referralCode:myCode,
    referralCount:0,
    referralEarnings:0,
    createdAt:serverTimestamp()
  });

  if(refCode){
    const q = await getDoc(doc(db,"ref_codes",refCode));
    if(q.exists()){
      const inviterUid = q.data().uid;
      await updateDoc(doc(db,"users",inviterUid),{
        balance: q.data().balance + 0.09,
        referralCount: q.data().referralCount + 1,
        referralEarnings: q.data().referralEarnings + 0.09
      });
      await addDoc(collection(db,"referrals"),{
        inviterUid,
        invitedUid:uid,
        createdAt:serverTimestamp()
      });
    }
  }

  await setDoc(doc(db,"ref_codes",myCode),{uid},{merge:true});
  location.href="index.html";
};
</script>
</body>
</html>
