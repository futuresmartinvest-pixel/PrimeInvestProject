<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin VIP Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  margin: 0;
  padding: 16px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #0f172a;
  color: #fff;
}

h2 {
  margin-bottom: 16px;
}

.card {
  background: #1e293b;
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
}

.card div {
  margin-bottom: 6px;
}

button {
  background: #22c55e;
  color: #000;
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
}

button:disabled {
  background: #555;
  cursor: not-allowed;
}
</style>
</head>

<body>

<h2>üî• VIP Requests (Admin)</h2>
<div id="vipList"></div>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  updateDoc,
  setDoc,
  doc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üîê FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyA1HZLZRY9UADNnDVBnoBIlG3b-bCkojxs",
  authDomain: "primeinvestproject2.firebaseapp.com",
  projectId: "primeinvestproject2",
  storageBucket: "primeinvestproject2.firebasestorage.app",
  messagingSenderId: "798977477628",
  appId: "1:798977477628:web:c97d1fba72ad7865864079"
};

/* INIT */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const vipList = document.getElementById("vipList");

/* ================= LOAD REQUESTS ================= */
async function loadRequests() {
  vipList.innerHTML = "";

  const snap = await getDocs(collection(db, "vip_requests"));

  if (snap.empty) {
    vipList.innerHTML = "<p>No VIP requests</p>";
    return;
  }

  snap.forEach((docSnap) => {
    const data = docSnap.data();

    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <div><b>User ID:</b> ${data.userId}</div>
      <div><b>VIP Level:</b> ${data.vipLevel}</div>
      <div><b>Price:</b> $${data.price}</div>
      <div><b>Status:</b> ${data.status}</div>
      ${
        data.status === "pending"
          ? `<button>Approve VIP</button>`
          : `<button disabled>Approved</button>`
      }
    `;

    if (data.status === "pending") {
      div.querySelector("button").onclick = async () => {
        // 1Ô∏è‚É£ Update request status
        await updateDoc(doc(db, "vip_requests", docSnap.id), {
          status: "approved",
          approvedAt: serverTimestamp()
        });

        // 2Ô∏è‚É£ Activate VIP globally for user
        await setDoc(
          doc(db, "users", data.userId),
          {
            vip: {
              level: data.vipLevel,
              price: data.price,
              status: "active",
              startAt: serverTimestamp(),
              lastProfitAt: serverTimestamp()
            }
          },
          { merge: true }
        );

        alert("‚úÖ VIP Approved & Activated");
        loadRequests();
      };
    }

    vipList.appendChild(div);
  });
}

/* RUN */
loadRequests();
</script>

</body>
</html>
