<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>VIP Deposit</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(180deg,#05070f,#0a0f24);
  color:#fff;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.card{
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.25);
  backdrop-filter:blur(18px);
  border-radius:22px;
  padding:22px;
  width:90%;
  max-width:360px;
  text-align:center;
}

button{
  margin-top:18px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:14px;
  font-size:16px;
  font-weight:900;
  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#000;
  cursor:pointer;
}
button:disabled{
  opacity:.6;
}
.small{
  opacity:.8;
  font-size:13px;
}
</style>
</head>

<body>

<div class="card">
  <h2 id="title">VIP</h2>
  <p id="price"></p>
  <p class="small">Your request will be sent for admin approval.</p>
  <button id="sendBtn">Send VIP Request</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyA1HZLZRY9UADNnDVBnoBIlG3b-bCkojxs",
  authDomain: "primeinvestproject2.firebaseapp.com",
  projectId: "primeinvestproject2",
  storageBucket: "primeinvestproject2.firebasestorage.app",
  messagingSenderId: "798977477628",
  appId: "1:798977477628:web:c97d1fba72ad7865864079"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* SAFE USER ID */
function getUserId(){
  let id = localStorage.getItem("userId");
  if(!id){
    alert("User not found");
    throw new Error("No userId");
  }
  return id;
}
const userId = getUserId();

/* READ & VALIDATE URL PARAMS */
const params = new URLSearchParams(location.search);
const vipLevel = Number(params.get("vip"));
const price = Number(params.get("price"));

/* HARD VALIDATION (ANTI-TAMPER) */
const VALID_VIPS = {
  1:30, 2:100, 3:499, 4:999,
  5:4999, 6:9999, 7:49999, 8:99999
};

if(!VALID_VIPS[vipLevel] || VALID_VIPS[vipLevel] !== price){
  alert("Invalid VIP request");
  location.href = "vip.html";
}

/* UI */
document.getElementById("title").textContent = `VIP ${vipLevel}`;
document.getElementById("price").textContent = `Price: $${price}`;

/* SUBMIT REQUEST */
const btn = document.getElementById("sendBtn");

btn.onclick = async ()=>{
  btn.disabled = true;

  /* Prevent duplicate pending requests */
  const reqRef = doc(db,"vip_requests",`${userId}_vip_${vipLevel}`);
  const snap = await getDoc(reqRef);

  if(snap.exists() && snap.data().status === "pending"){
    alert("You already have a pending request");
    btn.disabled = false;
    return;
  }

  await setDoc(reqRef,{
    userId: userId,
    vipLevel: vipLevel,
    price: price,
    status: "pending",
    createdAt: serverTimestamp()
  });

  alert("VIP request sent. Await admin approval.");
  location.href = "index.html";
};
</script>

</body>
</html>
